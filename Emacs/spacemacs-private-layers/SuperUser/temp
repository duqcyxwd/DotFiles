(message "Hi, Start loading customer config")

(eval-when-compile
  (require 'use-package))

(use-package diminish
  :ensure t)

(use-package bind-key
  :ensure t
  :bind ())

(global-set-key (kbd "M-`") 'other-frame-or-window)
(setq ido-separator "\n")
(setq ido-enable-flex-matching t)

(ido-mode 1)
(setq ns-pop-up-frames nil)
(setq truncate-lines -1)

;;; (when (display-graphic-p) (load-theme 'solarized-dark t))

;; Start Emacs server so we can call emacs client
;; (server-start)


(use-package smooth-scroll
  :ensure t
  :config (progn
            (smooth-scroll-mode 1)
            (setq scroll-margin 50
                  scroll-conservatively 9999
                  auto-window-vscroll nil
                  scroll-step 1)))

(use-package neotree :ensure t
  :bind ("<f8>" . neotree-toggle))

(use-package multiple-cursors :ensure t :pin melpa-stable
  :bind (("C->" . mc/mark-next-like-this)
         ("C-<" . mc/mark-previous-like-this)
         ("C-c C->" . mc/mark-all-like-this)
         ("C-S-c C-S-c" . mc/edit-lines)
         ("C-S-c C-e" . mc/edit-ends-of-lines)))

(use-package fold-dwim :ensure t
  :pin melpa-stable
  :bind (("<M-tab>" . fold-dwim-toggle)
         ("C-f" . fold-dwim-hide-all)
         ("H-s" . fold-dwim-show-all)))

(use-package hideshowvis :ensure t
  ;;Puts a plus/minus symbol in the fringe for things you can fold (hide)
  :init (add-hook 'prog-mode-hook 'hideshowvis-minor-mode))

;; (use-package drag-stuff
;;   :load-path "/Users/chuan.du/.emacs.d/elpa/drag-stuff-0.1.0/")


;; Not working yet
;;Exit insert mode by pressing j and then j quickly
;; (use-package key-chord
;;   :ensure t
;;   :config (progn (setq key-chord-two-keys-delay 0.3)
;;                  (key-chord-mode 1)))

;; (use-package minimap
;;   :ensure t
;;   :config (progn
;;             (minimap-mode 0)))

;; edit-server allow emacs to edit stuff form browser
;; (use-package edit-server
;;   :ensure t
;;   :config (edit-server-start))

;;; Evil stuff

;; (put-clojure-indent 'partial 5)

;; Tip M+: Eval a Expression
;; (equal major-mode 'cider-repl-mode)

(use-package evil-leader
  :ensure t
  :config )

;;; displays all the evil marks you have registered on a buffer
(use-package evil-visual-mark-mode
  :ensure t
  :config (evil-visual-mark-mode 1))

;;; hit `*` to search the selection forward, or # to search that selection backward.
(use-package evil-visualstar
  :ensure t
  :config (global-evil-visualstar-mode 1))

(use-package evil-cleverparens
  :ensure t
  :config (evil-cleverparens-mode 1))

(use-package whitespace :ensure t
  :init (setq whitespace-style '(face trailing lines-tail tabs)
              whitespace-line-column 80))

(use-package auto-indent-mode :ensure t
  :init (setq auto-indent-on-save-file t
              auto-indent-blank-lines-on-move nil
              auto-indent-delete-trailing-whitespace-on-save-file t
              auto-indent-untabify-on-save-file t
              auto-indent-indent-style 'aggressive)
  :config (auto-indent-global-mode)
  :diminish auto-indent-mode)

(use-package solarized-theme :ensure t
  :init (progn
          (setq solarized-high-contrast-mode-line t
                solarized-use-less-bold t
                solarized-emphasize-indicators nil
                solarized-scale-org-headlines nil
                x-underline-at-descent-line t)
          (load-theme 'solarized-dark' no-confirm))
  :config (setq color-theme-is-global t))

(defun powerline-center-evil-theme-cus ()
  "Setup a mode-line with major, evil, and minor modes centered."
  (interactive)
  (setq-default mode-line-format
                '("%e"
                  (:eval
                   (let* ((file-name (buffer-file-name (current-buffer)))
                          (active (powerline-selected-window-active))
                          (mode-line (if active 'mode-line 'mode-line-inactive))
                          (face2 (if active 'powerline-active2 'powerline-inactive2))
                          (face1 (if active 'powerline-active1 'powerline-inactive1))
                          (separator-left (intern (format "powerline-%s-%s"
                                                          (powerline-current-separator)
                                                          (car powerline-default-separator-dir))))
                          (separator-right (intern (format "powerline-%s-%s"
                                                           (powerline-current-separator)
                                                           (cdr powerline-default-separator-dir))))
                          (lhs (list (powerline-raw "[" face1)
                                     (powerline-raw (projectile-project-name) face1)
                                     (powerline-raw (concat ""
                                                            (when (and file-name vc-mode)
                                                              (concat ":" (-> file-name
                                                                              vc-working-revision
                                                                              (string-utils-truncate-to 10))
                                                                      "")))
                                                    face1)
                                     (powerline-raw "]" face1)
                                     (powerline-raw " %*%b%* " face1)
                                     (funcall separator-left face1 mode-line)
                                     (powerline-buffer-size nil 'l)
                                     (powerline-raw " ")
                                     (funcall separator-left mode-line face1)

                                     ;; (powerline-narrow face2 'l)
                                     ;; (powerline-vc face1)
                                     ))
                          (rhs (append (list (powerline-raw global-mode-string face1 'r)
                                             (powerline-raw "%4l" face1 'r)
                                             (powerline-raw ":" face1)
                                             (powerline-raw "%3c" face1 'r)
                                             (funcall separator-right face1 mode-line)
                                             (powerline-raw " ")
                                             (powerline-raw "%3p" nil 'r)
                                             )
                                       (if evil-mode
                                           (list (funcall separator-right mode-line face1)
                                                 (powerline-raw evil-mode-line-tag face1 'l)
                                                 (powerline-raw " " face1)
                                                 ;; (funcall separator-left face1 face2)
                                                 ))
                                       ;; (list
                                       ;;  (powerline-hud face1 face2))
                                       ))
                          (center (append (list (powerline-raw " " face1)
                                                (funcall separator-left face1 face2)
                                                (when (and (boundp 'erc-track-minor-mode) erc-track-minor-mode)
                                                  (powerline-raw erc-modified-channels-object face2 'l))
                                                (powerline-major-mode face2 'l)
                                                (powerline-process face2)
                                                (powerline-raw " " face2))
                                          ;; (if (split-string (format-mode-line minor-mode-alist))
                                          ;;     ;; (append (if evil-mode
                                          ;;     ;;             (list (funcall separator-right face2 face1)
                                          ;;     ;;                   (powerline-raw evil-mode-line-tag face1 'l)
                                          ;;     ;;                   (powerline-raw " " face1)
                                          ;;     ;;                   (funcall separator-left face1 face2)))
                                          ;;     ;;         ;; (list (powerline-minor-modes face2 'l)
                                          ;;     ;;         ;;       (powerline-raw " " face2)
                                          ;;     ;;         ;;       (funcall separator-right face2 face1))
                                          ;;     ;;         )
                                          ;;     (list (powerline-raw evil-mode-line-tag face2)
                                          ;;           (funcall separator-right face2 face1)))
                                          )))
                     (concat (powerline-render lhs)
                             (powerline-fill-center face1 (/ (powerline-width center) 2.0))
                             ;; (powerline-render center)
                             (powerline-fill face1 (powerline-width rhs))
                             (powerline-render rhs)))))))

(use-package powerline :ensure t
  :config (progn
            ;; (powerline-light-thme)
            ;; (powerline-default-theme)
            (powerline-center-evil-theme-cus)
            (setq powerline-arrow-shape 'arrow)))


;; (use-package layout-restore
;;   :ensure t)

(defun my-update-modified-flag ()
  "Update the buffer modified flag."
  (interactive)
  (let* ((buffer (current-buffer))
         (basefile
          (or (buffer-file-name buffer)
              (error "Buffer %s has no associated file" buffer)))
         (tempfile (make-temp-file "buffer-content-")))
    (with-current-buffer buffer
      (save-restriction
        (widen)
        (write-region (point-min) (point-max) tempfile nil 'silent)))
    (if (= (call-process "diff" nil nil nil basefile tempfile) 0)
        (progn
          (set-buffer-modified-p nil)
          (message "Buffer matches file"))
      (message "Buffer doesn't match file"))
    (delete-file tempfile)))

;; Disable the annoying square
(setq ring-bell-function 'ignore)

(global-set-key (kbd "M-9") 'paredit-wrap-round)
;; (global-set-key (kbd "C-<right>") 'paredit-forward-slurp-sexp)


;; Leader config
(progn (evil-leader/set-leader ",")

       (evil-leader/set-key "w" 'save-buffer)
       (evil-leader/set-key "u" 'dired-jump)
       (evil-leader/set-key "," 'evil-switch-to-windows-last-buffer)
       ;; (evil-leader/set-key "h" 'other-window)
       (evil-leader/set-key "m" 'minimap-mode)
       (evil-leader/set-key "b" 'ido-switch-buffer)
       (evil-leader/set-key "f" 'projectile-find-file-dwim)
       (evil-leader/set-key "r" 'ido-imenu)
       (evil-leader/set-key "g" 'cider-repl-previous-matching-input)
       (evil-leader/set-key-for-mode 'text-mode "k" 'edit-server-done) ;; connection for edit-server on brower
       ;; (evil-leader/set-key "d" 'edit-server-done)
       ;; (evil-leader/set-key "x" 'kill-this-buffer)

       ;; Ace-jump mode
       ;; toggle-case-fold-search
       (evil-leader/set-key "o" 'evil-ace-jump-line-mode)
       (evil-leader/set-key "j" 'evil-ace-jump-word-mode)
       (evil-leader/set-key "s" 'ag-project)

       ;; (evil-leader/set-key
       ;;   "ci" 'evilnc-comment-or-uncomment-lines
       ;;   "cl" 'evilnc-quick-comment-or-uncomment-to-the-line)


       ;; Buffer and windwow
       (evil-leader/set-key "h" 'cider-popup-buffer-quit-function)
       (evil-leader/set-key "k" 'kill-this-buffer)
       (evil-leader/set-key "H" 'evil-window-move-far-left)
       (evil-leader/set-key "L" 'evil-window-move-far-right)
       (evil-leader/set-key "J" 'evil-window-move-very-bottom)
       (evil-leader/set-key "K" 'evil-window-move-very-top)


       (evil-leader/set-key "T" 'toggle-truncate-lines)
       (evil-leader/set-key "E"
         (lambda () (interactive)
           (eval-current-buffer)
           (set-face-to-large)))
       (evil-leader/set-key "W" 'whitespace-mode)

       ;; cider
       (evil-leader/set-key "t" 'cider-pprint-eval-defun-at-point)
       (evil-leader/set-key "q" 'kill-buffer-and-window)
       (evil-leader/set-key "e" 'cider-eval-last-sexp)
       (evil-leader/set-key "n" 'cider-repl-set-ns)

       (evil-leader/set-key "cn" 'neotree-toggle)
       (evil-leader/set-key-for-mode 'clojure-mode "cc" 'cider-load-buffer)
       (evil-leader/set-key-for-mode 'cider-repl-mode "cc" 'cider-repl-clear-buffer)


       (evil-leader/set-key "v" 'cider-switch-to-repl-buffer-clojure-buffer)
       (evil-leader/set-key "l" 'evil-cleverparens-mode)
       (evil-leader/set-key "'" 'evil-visual-mark-mode)

       ;; Window operation
       ;; C-w, r Rotate windows
       ;; gs windows swap
       ;; (evil-window-rotate-upwards)
       ;;  C-w L/K/J/H.
       ;; (evil-leader/set-key "0" 'delete-window)
       (evil-leader/set-key "C" 'delete-window)
       (evil-leader/set-key "1" 'delete-other-windows)

       (evil-leader/set-key "S" 'ace-swap-window)
       (evil-leader/set-key "7" 'set-face-to-small)
       (evil-leader/set-key "8" 'set-face-to-medium)
       (evil-leader/set-key "9" 'set-face-to-large)

       (global-evil-leader-mode 1)
       (evil-leader-mode))
