# /*****************************/
# /*  _____ __  __ _   ___  __ */
# /* |_   _|  \/  | | | \ \/ / */
# /*   | | | |\/| | | | |\  /  */
# /*   | | | |  | | |_| |/  \  */
# /*   |_| |_|  |_|\___//_/\_\ */
# /*                           */
# /*****************************/

# Tmux Manual 1:
# https://man7.org/linux/man-pages/man1/tmux.1.html
# Tmux Manul2:
# http://man.openbsd.org/OpenBSD-current/man1/tmux.1#choose-tree
# Example config:
# https://www.barbarianmeetscoding.com/blog/jaimes-guide-to-tmux-the-most-awesome-tool-you-didnt-know-you-needed
# An good example from Waylon Walker
# https://github.com/WaylonWalker/devtainer/blob/main/tmux/.tmux.conf
# tmux list-keys to list all keys

# Prefix binding {{{1
# ------------------------------------------------------------------------------
# Default prefix is 'C-b'
unbind C-b
set -g prefix 'C-a'
bind 'C-a' send-prefix


# Tmux function mapping (choose-tree/display-panes/source-file) {{{1
# ------------------------------------------------------------------------------

bind r     source-file ~/.tmux.conf \; display-message "tmux.conf reloaded!!"
bind :     command-prompt
bind q     display-panes


# Navigation Window/Panel/Session{{{1
# ------------------------------------------------------------------------------

# choose-tree
# Use choose-tree and T to tag stuff, X to delete
# Tree mode tips: https://github.com/tmux/tmux/wiki/Getting-Started#choosing-sessions-windows-and-panes
# Use t to tag and X to kill tags session window


# bind w choose-tree
bind 'C-\' choose-window
bind '\'   choose-tree -swZ
bind t     choose-tree -wZ

# Session
# This a default mapping and I just add -r
# Use 9/0 switch session
# -------------------------------------#


# Session navigation
bind -r Up   switch-client -p          # Choose previous client
bind -r Down switch-client -n          # Choose next client
# bind -r 9     switch-client -p         # Choose previous client
# bind -r 0     switch-client -n         # Choose next client
bind -r Tab   switch-client -l         # Choose Last Session
bind -r c-b   switch-client -l         # Choose Last Session

# Window navigation
bind Right next-window                 # Alacritty mapped to cmd-right
bind Left  previous-window             # Alacritty mapped to Cmd-left

# Panel navigation
# Alacritty mapped to Cmd-[ and cmd-]
bind O select-pane -t :.-
bind o select-pane -t :.+

# Session recent, (Already there)
# Default bind Tab last-window
# Default bind -r Tab last-window

# Smart Panel Navigation Moving with VIM keys {{{2
# ------------------------------------------------------------------------------

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

# bind -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -l'
# Prefix <C-\> is already used, I don't need this recent panel, I am using tmux
# 3.2
# tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
# if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
#     "bind -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
# if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
#     "bind -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"


bind -T copy-mode-vi 'C-h' select-pane -L # Left
bind -T copy-mode-vi 'C-j' select-pane -D # Down
bind -T copy-mode-vi 'C-k' select-pane -U # Up
bind -T copy-mode-vi 'C-l' select-pane -R # Right
# bind -T copy-mode-vi 'C-\' select-pane -l # Recent

bind h select-pane -L # Left
bind j select-pane -D # Down
bind k select-pane -U # Up
bind l select-pane -R # Right

# }}}1
# Create/Split/Delete Session/Window/Panel {{{1
# ------------------------------------------------------------------------------
unbind n
unbind v
unbind s
unbind x

# Session
bind n new-session -c '#{pane_current_path}'   # Alacritty M-n

# Window
bind t new-window -c '#{pane_current_path}'      # Alacritty M-t
# Default C-a &          kill the current window

# Panel
bind v split-window -h -c '#{pane_current_path}' # Alacritty M-d
bind s split-window -v -c '#{pane_current_path}' # Alacritty M-S-d
bind x kill-pane                                 # Alacritty M-w


# Layout {{{1
# ------------------------------------------------------------------------------
# Change layout {{{2
#  [Move window to pane](http://unix.stackexchange.com/questions/14300/tmux-move-window-to-pane)

# Window Swap
bind -n C-S-Left  swap-window -d -t -1 # Move window left
bind -n C-S-Right swap-window -d -t +1 # Move window right

bind + select-layout main-horizontal
bind = select-layout main-vertical

bind -r C-o rotate-window
bind -r c-y next-layout

# z: make a pane go full screen. Hit C-b z again to shrink it back to its previous size
# C-<arrow key>: Resize pane in direction of <arrow key>4


# Change Panel Size <ArrowKeys> {{{2
# ------------------------------------------------------------------------------

# :joinp -s :2<CR>  # move window 2 into a new pane in the current window
# :joinp -t :1<CR>  # move the current pane into a new pane in window 1
# .                 # move window - prompted for a new number
#:break-pane        # move current pane into a new window
# :move-panel -t 0  # Swap panel


# Build-in, not need to update
bind -r -T prefix C-Up    resize-pane -U 5
bind -r -T prefix C-Down  resize-pane -D 5
bind -r -T prefix C-Left  resize-pane -L 5
bind -r -T prefix C-Right resize-pane -R 5

# Not using -r becasue you will not know when timeout ends
# L bind to last-session
# Default Prefix + z
bind -r enter resize-pane -Z

# }}}1
# Rename Session/window {{{1
# ------------------------------------------------------------------------------
# Default
# :renamew          # Rename window
# prefix ,          # rename the current window
# prefix $          # rename the current session

# Copy Mode {{{1
# ------------------------------------------------------------------------------
bind C-[ copy-mode
bind [   copy-mode
bind ]   paste-buffer
# bind r refresh-client

# Setup 'v' to begin selection as in Vim
# bind -T copy-mode-vi   Enter send-keys -X begin-selection
# bind -T copy-mode-vi Enter send-keys -X begin-selection
# bind -T copy-mode-vi Enter send -X begin-selection \; send-keys -R \; send-keys -t ! \033[6 q
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'
bind -T copy-mode-vi r send-keys -X rectangle-toggle

# Update default binding of `Enter` to also use copy-pipe
unbind -T copy-mode-vi Enter
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"


# Enable native Mac OS X copy/paste
set -g default-command "/bin/bash -c 'which reattach-to-user-namespace >/dev/null && exec reattach-to-user-namespace $SHELL -l || exec $SHELL -l'"

# Mouse Key {{{1
# ------------------------------------------------------------------------------

# macOS only
set  -g mouse on

# mouse wheel up to enter copy mode, whell down back to insert mode
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M
bind -n C-WheelUpPane select-pane -t= \; copy-mode -e \; send-keys -M

# To copy, left click and drag to highlight text in yellow
# I like to stay in copy-mode after copy, press middle mouse twice to exit
# copy-mode and paste
bind -T copy-mode-vi C-WheelUpPane     send-keys -X  halfpage-up
bind -T copy-mode-vi C-WheelDownPane   send-keys -X  halfpage-down
bind -T copy-mode-vi WheelUpPane       send-keys -N1 -X scroll-up
bind -T copy-mode-vi WheelDownPane     send-keys -N1 -X scroll-down
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X  copy-pipe
bind -T copy-mode-vi MouseDown2Pane    send-keys -X  cancel

# bind -n MouseDown2Pane paste-buffer

# Colors/Theme {{{1
# ------------------------------------------------------------------------------
setw -g other-pane-height 25
setw -g other-pane-width 80

set -gq status-utf8         on     # enable UTF-8 support in status bar
set -g  status-justify      centre # center the status bar
set -g  status-left-length  20     # Show more things on left
set -g  status-right-length 20     # Show more things on right
set -g  status-interval     0      # update status bar info

# # Color scheme 1
# # Status Bar
# set -g status-style bg=black
# set -g status-style fg=white
# set -g pane-border-style fg=cyan
# set -g pane-active-border-style fg=yellow
# # set -g status-left '#[fg=green]#H #[default]'
# set -g status-left '#[fg=green] #S #[fg=yellow]#I/#[fg=cyan]#P '
# # show hostname, date, tim 100
# # set -g status-right '%a%l:%M:%S %p#[default] #[fg=blue]%Y-%m-%d'
# set -g status-right '#(battery -t) #[fg=cyan] %d %b %R '
# set -g message-style bg='#44475a',fg='#8be9fd'


# Color scheme 2
# {{Dracula}} with my changes
# https://cassidy.codes/blog/2019-08-03-tmux-colour-theme/
## Dracula Colours
# background_color '#282a36'
# current_line_color '#44475a'
# foreground_color '#f8f8f2'
# comment_color '#6272a4'
# cyan '#8be9fd'
# green '#50fa7b'
# orange '#ffb86c'
# pink '#ff79c6'
# purple '#bd93f9'
# red '#ff5555'
# yellow '#f1fa8c'

# pane border
set -g  pane-border-style fg='#6272a4'
set -g  pane-active-border-style fg='#ff79c6'

# message text
set -g  message-style bg='#282a36',fg='#8be9fd'
set -g  status-style bg='#282a36',fg='#bd93f9'

# status left
# are we controlling tmux or the content of the panes?
set -g  status-left '#{?client_prefix,#[bg=#44475a],#[bg=#282a36]}#[fg=#f8f8f2]#{?client_prefix, P,  }'
set -ga status-left '#[fg=#f8f8f2] S:#S #[fg=yellow]#I/#[fg=cyan]#P'
set -ga status-left '#[fg=#ff79c6] #{?window_zoomed_flag, ↕  ,   }'


# window status
setw -g window-status-style fg='#bd93f9',bg=default
setw -g window-status-current-style fg='#ff79c6',bg='#282a36'
# set -g window-status-activity-style bg=black,fg='underscore bold'
set -g window-status-bell-style fg="#bd93f9"
set -g window-status-activity-style 'fg=white bold underscore'

# set -g window-status-current-format "#[fg=#282a36]#[bg=#bd93f9]#[fg=#f8f8f2]#[bg=#bd93f9] #I #W #[fg=#bd93f9]#[bg=#282a36]"
# set -g window-status-current-format "#[fg=#282a36]#[bg=#f1fa8c]#[fg=#000000]#[bg=#f1fa8c] #I #W #[fg=#f1fa8c]#[bg=#282a36]"
# set -g window-status-current-format "#[fg=#282a36]#[bg=#6272a4]#[fg=#f8f8f2]#[bg=#6272a4] #I #W #[fg=#6272a4]#[bg=#282a36]"

set -g window-status-current-format "#[fg=#282a36]#[bg=#50fa7b]#[fg=#000000]#[bg=#50fa7b] #I #W #[fg=#50fa7b]#[bg=#282a36]"
set -g window-status-format         "#[fg=#282a36]#[bg=#282a36]#[fg=#f8f8f2]#[bg=#282a36] #I #W #[fg=#282a36]#[bg=#282a36]"

# # Original
# set -g window-status-current-format "#[fg=#44475a]#[bg=#bd93f9]#[fg=#f8f8f2]#[bg=#bd93f9] #I #W #[fg=#bd93f9]#[bg=#44475a]"
# set -g window-status-format "#[fg=#f8f8f2]#[bg=#44475a]#I #W #[fg=#44475a] "

# status right WIP
# set -g status-right '#[fg=#ff79c6]#{?client_prefix,#[bg=#44475a],#[bg=#282a36]} %d %b %R  #(uptime | cut -f 1-5 -d " " | cut -f 1 -d ",") '
set -g status-right '#[fg=#ff79c6]#{?client_prefix,#[bg=#44475a],#[bg=#282a36]} %d %b  #(uptime | cut -f 1-5 -d " " | cut -f 1 -d ",") '

# Tmux Configuration {{{1
# ------------------------------------------------------------------------------

# use 256 xterm for pretty colors. This enables same colors from iTerm2 within tmux.
# This is recommended in neovim :healthcheck
# alacritty:Tc will fix ranger/nnn color problem
set -g  default-terminal "tmux-256color"
set -a terminal-overrides ",alacritty:RGB,alacritty:Tc"

# set -g  default-terminal "xterm-256color"
# set -g  default-terminal "screen-256color"
# set -ga terminal-overrides ",alacritty:Tc"
# set-option -a terminal-overrides ",*256col*:RGB, "


# set -g default-terminal "tmux-256color"
# set -ga terminal-overrides ",tmux-256color:Tc"


set  -g  detach-on-destroy  off    # Disable detach on destory
set  -g  history-limit      100000 # increase scroll-back history
setw -g  mode-keys          vi     # vi is good

setw -g  automatic-rename   on
setw -g  display-panes-time 1500
set  -g  repeat-time        1001   # prefix key timeout, works with option -r
set  -g  renumber-windows   on     # re-number windows when one is closed

set  -g  base-index         1      # start window index at 1 instead of 0
setw -g  pane-base-index    1      # start pane index at 1 instead of 0

setw -g  monitor-activity   on     # highlight window when it has new activity
set  -g  visual-activity    off    # display a message when activity occurs

# set  -sg escape-time        2      # decrease command delay (increases vim responsiveness)
# WIP https://www.johnhawthorn.com/2012/09/vi-escape-delays/
set  -sg escape-time        0      # decrease command delay (increases vim responsiveness)
set  -g  focus-events       on

# Default session {{{1
# ------------------------------------------------------------------------------

## Create a single default session - because a session is created here, tmux
## should be started with "tmux attach" rather than "tmux new"

new-session -d    -s0               -nDefault 'zsh'
# new-window  -d    -nmain            'zsh'

# new-session -d    -s0               -nDefault 'zsh'
# new-window  -d    -ntodo            'exec nvim ~/vimwiki/TODO.md'
# new-window  -d    -nmain            'zsh'



# Tmux Plugins: {{{1
# ------------------------------------------------------------------------------
# List of plugins

set -g @plugin 'junegunn/tmux-fzf-url'       # prefix u
set -g @plugin 'laktak/extrakto'             # complete typing that is already on the screen
set -g @plugin 'sainnhe/tmux-fzf'            # prefix c-f
set -g @plugin 'tmux-plugins/tmux-continuum' # continuous saving / auto loading tmux environment
set -g @plugin 'tmux-plugins/tmux-resurrect' # Restore tmux environment after system restart.
set -g @plugin 'tmux-plugins/tpm'            # Tmux Plugin Manager

set -g @treemux-tree-nvim-init-file "$HOME/.tmux/treemux_init.lua"
# set -g @plugin 'kiyoon/treemux'              # WIP opens a sidebar with Neovim's Nvim-Tree file explorer

TMUX_FZF_LAUNCH_KEY="C-f"

# set -g @extrakto_clip_tool  "xsel --input --clipboard" # works better for nvim
set -g @extrakto_key        "space"
set -g @extrakto_copy_key   "tab"                      # use tab to copy to clipboard
set -g @extrakto_insert_key "enter"                    # use enter to insert selection
set -g @extrakto_popup_size "50%"                      # popup size
set -g @extrakto_grab_area  "recent"
# set -g @extrakto_split_size "7"

# junegunn/tmux-fzf-url select url in your terminal
# Bind-key (default: 'u')
set -g @fzf-url-bind 'u'
# fzf-tmux layout (default: '-p70%' on tmux 3.2, '-d' otherwise)
#   (-p requires tmux 3.2 or above, see `man fzf-tmux` for available options)
set -g @fzf-url-layout '-p70%'


# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'


# Overwrite Plugins config {{{1
# ------------------------------------------------------------------------------
# None
# Special binding {{{1
# ------------------------------------------------------------------------------

bind C-l send-keys 'C-l' # for clean screen
bind C-k clear-history   # Alacritty can send this by Cmd-k
# k is used for window switch
# bind k clear-history   # Alacritty can send this by Cmd-k



bind g display-popup -h 95% -w 95% -d '#{pane_current_path}' -E 'lazygit'
bind 6 new-session -A -s dev "tmux switch-client -t dev"
bind 7 new-session -A -s dot "tmux switch-client -t dot"

# Toggle scratch
bind 8 if-shell -F '#{==:#{session_name},scratch}' { detach-client } {
    display-popup -h 90% -w 90% -E "tmux new-session -A -s scratch" }
# }}}1
